	<link rel="stylesheet" href="#CHEMIN{lib/leaflet/leaflet.css}" ></link>
	<link rel="stylesheet" href="#CHEMIN{lib/leaflet/plugins/leaflet.fullscreen.css}" ></link>
	<link rel="stylesheet" href="#CHEMIN{css/cartetrav.css}" ></link>
	<style>
	.leaflet-marker-pane {
	    z-index: 4;
	}
	.leaflet-shadow-pane {
		z-index: 3;
	}
	.leaflet-popup {
		z-index: 1203;
	}
	.leaflet-control {
	    float: none;
	    display: inline-block;
	}
	
	#maptrav .leaflet-control-layers {
		display:  none;
	}
	#controls .leaflet-control-layers {
		margin: 5px;
	}
	#leaflet-slider {
		margin: 20px;
	}
	#time-range p {
	    font-family:"Arial", sans-serif;
	    font-size:14px;
	    color:#333;
	}
	.ui-slider-horizontal {
	    height: 8px;
	    background: #D7D7D7;
	    border: 1px solid #BABABA;
	    box-shadow: 0 1px 0 #FFF, 0 1px 0 #CFCFCF inset;
	    clear: both;
	    margin: 8px 0;
	    -webkit-border-radius: 6px;
	    -moz-border-radius: 6px;
	    -ms-border-radius: 6px;
	    -o-border-radius: 6px;
	    border-radius: 6px;
	}
	.ui-slider {
	    position: relative;
	    text-align: left;
	}
	.ui-slider-horizontal .ui-slider-range {
	    top: -1px;
	    height: 100%;
	}
	.ui-slider .ui-slider-range {
	    position: absolute;
	    z-index: 1;
	    height: 8px;
	    font-size: .7em;
	    display: block;
	    border: 1px solid #5BA8E1;
	    box-shadow: 0 1px 0 #AAD6F6 inset;
	    -moz-border-radius: 6px;
	    -webkit-border-radius: 6px;
	    -khtml-border-radius: 6px;
	    border-radius: 6px;
	    background: #81B8F3;
	    background-image: url('data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgi…pZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjZ3JhZCkiIC8+PC9zdmc+IA==');
	    background-size: 100%;
	    background-image: -webkit-gradient(linear, 50% 0, 50% 100%, color-stop(0%, #A0D4F5), color-stop(100%, #81B8F3));
	    background-image: -webkit-linear-gradient(top, #A0D4F5, #81B8F3);
	    background-image: -moz-linear-gradient(top, #A0D4F5, #81B8F3);
	    background-image: -o-linear-gradient(top, #A0D4F5, #81B8F3);
	    background-image: linear-gradient(top, #A0D4F5, #81B8F3);
	}
	.ui-slider .ui-slider-handle {
	    border-radius: 50%;
	    background: #F9FBFA;
	    background-image: url('data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgi…pZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjZ3JhZCkiIC8+PC9zdmc+IA==');
	    background-size: 100%;
	    background-image: -webkit-gradient(linear, 50% 0, 50% 100%, color-stop(0%, #C7CED6), color-stop(100%, #F9FBFA));
	    background-image: -webkit-linear-gradient(top, #C7CED6, #F9FBFA);
	    background-image: -moz-linear-gradient(top, #C7CED6, #F9FBFA);
	    background-image: -o-linear-gradient(top, #C7CED6, #F9FBFA);
	    background-image: linear-gradient(top, #C7CED6, #F9FBFA);
	    width: 22px;
	    height: 22px;
	    -webkit-box-shadow: 0 2px 3px -1px rgba(0, 0, 0, 0.6), 0 -1px 0 1px rgba(0, 0, 0, 0.15) inset, 0 1px 0 1px rgba(255, 255, 255, 0.9) inset;
	    -moz-box-shadow: 0 2px 3px -1px rgba(0, 0, 0, 0.6), 0 -1px 0 1px rgba(0, 0, 0, 0.15) inset, 0 1px 0 1px rgba(255, 255, 255, 0.9) inset;
	    box-shadow: 0 2px 3px -1px rgba(0, 0, 0, 0.6), 0 -1px 0 1px rgba(0, 0, 0, 0.15) inset, 0 1px 0 1px rgba(255, 255, 255, 0.9) inset;
	    -webkit-transition: box-shadow .3s;
	    -moz-transition: box-shadow .3s;
	    -o-transition: box-shadow .3s;
	    transition: box-shadow .3s;
	}
	.ui-slider .ui-slider-handle {
	    position: absolute;
	    z-index: 2;
	    width: 22px;
	    height: 22px;
	    cursor: default;
	    border: none;
	    cursor: pointer;
	}
	.ui-slider .ui-slider-handle:after {
	    content:"";
	    position: absolute;
	    width: 8px;
	    height: 8px;
	    border-radius: 50%;
	    top: 50%;
	    margin-top: -4px;
	    left: 50%;
	    margin-left: -4px;
	    background: #30A2D2;
	    -webkit-box-shadow: 0 1px 1px 1px rgba(22, 73, 163, 0.7) inset, 0 1px 0 0 #FFF;
	    -moz-box-shadow: 0 1px 1px 1px rgba(22, 73, 163, 0.7) inset, 0 1px 0 0 white;
	    box-shadow: 0 1px 1px 1px rgba(22, 73, 163, 0.7) inset, 0 1px 0 0 #FFF;
	}
	.ui-slider-horizontal .ui-slider-handle {
	    top: -.5em;
	    margin-left: -.6em;
	}
	.ui-slider a:focus {
	    outline:none;
	}
	</style>
	<div id="controls"></div>
	<div id="time-range">
	    <p>Time Range: <span class="slider-time"></span> - <span class="slider-time2"></span>
	
	    </p>
	    <div class="sliders_step1">
	        <div id="slider-range"></div>
	    </div>
	</div>
	<div id="leaflet-slider"></div>
	<div tabindex="0" class="map leaflet-container leaflet-fade-anim" id="maptrav" style="width: 100%; height: 600px; position: relative;"></div>
	<script src="#CHEMIN{lib/leaflet/leaflet.js}" type="text/javascript"></script>
	<script src="#CHEMIN{lib/leaflet/plugins/leaflet.snogylop.js}" type="text/javascript"></script>
	<script src="#CHEMIN{lib/leaflet/plugins/leaflet.fullscreen.min.js}" type="text/javascript"></script>
	<script src="#CHEMIN{lib/leaflet/plugins/SliderControl.js}" type="text/javascript"></script>
	<script>
		var maptrav = L.map('maptrav',{scrollWheelZoom:false,zoomControl:true,opacity:0.5,fullscreenControl: true}).setView([48.90903,2.45506 ], 11);
var mbAttr = '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors' + ' | <a href="http://geoportail93.fr">geoportail93.fr</a>';
//url des TMS de fond
var osm = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {attribution: mbAttr, maxZoom: 18});		// option pour le selecteur de couche
		var baseMaps = {
		    "OSM": osm
		};
		//on ajoute le fond OMS au départ
		osm.addTo(maptrav);
				
		var TravauxDVD = L.featureGroup().addTo(maptrav); // feature group ou on va inserer les travaux
		var TravauxPMI = L.featureGroup().addTo(maptrav); // feature group ou on va inserer les travaux
		var TravauxCRE = L.featureGroup().addTo(maptrav); // feature group ou on va inserer les travaux
		var TravauxASE = L.featureGroup().addTo(maptrav); // feature group ou on va inserer les travaux
		var fondCD = L.featureGroup().addTo(maptrav); // feature group ou on va inserer les fonds de cartes
		
		var overlayMaps = {
		    '<span class="travauxDVD">Travaux voirie</span>': TravauxDVD,
		    '<span class="travauxPMI">Centres PMI</span>': TravauxPMI,
		    '<span class="travauxCRE">Crèches</span>': TravauxCRE,
		    '<span class="travauxASE">Circonscriptions ASE</span>': TravauxASE
		};
		//on ajoute le 'control' des fonds de carte
		var optionsCont = {collapsed: false};
		var control = L.control.layers("",overlayMaps,optionsCont);
		control.addTo(maptrav);
		var controlDiv = control.onAdd(maptrav);
		$(document).ready(function(){
			$('#controls').append(controlDiv);
		});
		
		//on ajoute le bouton fullscreen
		maptrav.isFullscreen() // Is the map fullscreen?
		maptrav.toggleFullscreen() // Either go fullscreen, or cancel the existing fullscreen.
		
		// `fullscreenchange` Event that's fired when entering or exiting fullscreen.
		maptrav.on('fullscreenchange', function () {
		    if (maptrav.isFullscreen()) {
		        console.log('entered fullscreen');
		    } else {
		        console.log('exited fullscreen');
		    }
		});
		//L.Control.Fullscreen // A fullscreen button. Or use the `{fullscreenControl: true}` option when creating L.Map.
		
		
		var deptOptions = {
		    color: "#0AABA4",
		    fillColor: "#FFF",
		    weight: 1,
		    fillOpacity:0.9,
		    clickable: false
		};
		var dept93Options = {
		    color: "#0AABA4",
		    fillColor: "#FFF",
		    weight: 3,
		    opacity: 0.9,
		    fillOpacity:0.6,
		    clickable: false
		};
		var commOptions = {
		    color: "#888",
		    weight: 1,
		    opacity: 0.8,
		    fill: false,
		    clickable: false
		};
		var dvdIcon = L.icon({
			iconUrl: '#CHEMIN{images/marker-g1.png}',
			iconSize: [12, 20],
			iconAnchor: [6, 20],
			popupAnchor: [0, -14],
			fillOpacity:0.8,
			zIndex: 1500
		});
		var dvdOptions = {
		    radius: 2,
		    fillColor: "#f44",
		    color: "#f44",
		    weight: 2,
		    opacity: 1,
		    fillOpacity: 0.8,
		    zIndex: 1500
		};
		var pmiIcon = L.icon({
			iconUrl: '#CHEMIN{images/marker-g2.png}',
			iconSize: [12, 20],
			iconAnchor: [6, 20],
			popupAnchor: [0, -14],
			fillOpacity:0.8,
			zIndex: 1500
		});
		var pmiOptions = {
		   	radius: 4,
		   	fillColor: "#ff7800",
		   	color: "#000",
		   	weight: 1,
		   	opacity: 1,
		   	fillOpacity: 0.8
		};
		var aseIcon = L.icon({
			iconUrl: '#CHEMIN{images/marker-g3.png}',
			iconSize: [12, 20],
			iconAnchor: [6, 20],
			popupAnchor: [0, -14],
			fillOpacity:0.8,
			zIndex: 1500
		});
		var aseOptions = {
		    radius: 4,
		    fillColor: "#44f",
		    color: "#000",
		    weight: 1,
		    opacity: 1,
		    fillOpacity: 0.8
		};
		var creIcon = L.icon({
			iconUrl: '#CHEMIN{images/marker-g4.png}',
			iconSize: [12, 20],
			iconAnchor: [6, 20],
			popupAnchor: [0, -14],
			fillOpacity:0.8,
			zIndex: 1500
		});
		var creOptions = {
		    radius: 4,
		    fillColor: "#ff4",
		    color: "#000",
		    weight: 1,
		    opacity: 1,
		    fillOpacity: 0.8
		};
		
				
		//on ajoute la limite départementale
		$.ajax({
			url: "https://geoportail93.fr/SERV/DATA/?LAYERS=1049&FORMAT=geojson&SERVICE=wfs&SRS=4326&COL=all&FILTRE=depart%20LIKE%20%27SEINE-SAINT-DENIS%%27",
			dataType: 'json',
			}).done(function(data) {
				// Add the geojson layer to the map
				var dept_geojson = L.geoJson(data,{
					style: deptOptions,
					invert: true,
					worldLatLngs: [
					    L.latLng([90, 360]),
					    L.latLng([90, -180]),
					    L.latLng([-90, -180]),
					    L.latLng([-90, 360])
					]
				});
				dept_geojson.addTo(fondCD);
				var dept93_geojson = L.geoJson(data,{
					style: dept93Options,
				});
				dept93_geojson.addTo(fondCD);
			}).fail(function(jqXHR, textStatus, errorThrown) {
			// Nothing to do, there simply will be no overlay
		});
				
		//on ajoute les limites communales
		$.ajax({
			url: "https://geoportail93.fr/SERV/DATA/?LAYERS=1458&FORMAT=geojson&SERVICE=wfs&SRS=4326&COL=all&FILTRE=depart%20LIKE%20%27SEINE-SAINT-DENIS%%27",
			dataType: 'json',
			}).done(function(data) {
				// Add the geojson layer to the map
				var comm_geojson = L.geoJson(data,{
					style: commOptions
				});
				comm_geojson.addTo(fondCD);
			}).fail(function(jqXHR, textStatus, errorThrown) {
			// Nothing to do, there simply will be no overlay
		});		
		
		//ajout couche travaux formes
		
		
		$.ajax({
			url: "https://geoportail93.fr/SERV/DATA/?LAYERS=1296&FORMAT=geojson&SERVICE=wfs&SRS=4326&COL=ALL&FILTRE=termine%20IS%20FALSE",
			//url: "#CHEMIN{json/trav.geoportail93.geojson}",
			dataType: 'json',
			}).done(function(data) {
				// Add the geojson layer to the map
				var dvd_geojson = L.geoJson(data,{
					filter: function (feature, layer) {
						if (feature.properties) {
							// Si la propriétée "date_fin" existe et est inférieure à la date du jour, return false
							if (feature.properties.date_fin !== null) {
								var d1 = new Date([(#DATE|affdate{'Y'})],[(#DATE|affdate{'m'})],[(#DATE|affdate{'d'})]);
								var d2 = new Date(feature.properties.date_fin.substr(0,4),feature.properties.date_fin.substr(5,2),feature.properties.date_fin.substr(8,2));
								if (d2<d1) return false; else return true;
							}
						}
						return false;
					},
					style: dvdOptions,
					onEachFeature: onEachFeature
				});
				dvd_geojson.addTo(TravauxDVD);
				
			}).fail(function(jqXHR, textStatus, errorThrown) {
			// Nothing to do, there simply will be no overlay
		});
		
		
		//ajout couche travaux points
		$.ajax({
			//url: "https://geoportail93.fr/SERV/DATA/?LAYERS=1296&FORMAT=geojson&SERVICE=wfs&SRS=4326&COL=ALL&FILTRE=termine%20IS%20FALSE%20AND%20geom%20IS%20NOT%20NULL&MODE_GEO=point&ORDER=date_debut:ASC",
			url: "#CHEMIN{json/travpt.geoportail93.geojson}",
			dataType: 'json',
			}).done(function(data) {
				// Add the geojson layer to the map
				var dvdpt_geojson = L.geoJson(data,{
					/*
					filter: function (feature, layer) {
						
						if (feature.properties) {
							// Si la propriétée "date_fin" existe et est inférieure à la date du jour, return false
							if (feature.properties.date_fin !== null) {
								var d1 = new Date([(#DATE|affdate{'Y'})],[(#DATE|affdate{'m'})],[(#DATE|affdate{'d'})]);
								var d2 = new Date(feature.properties.date_fin.substr(0,4),feature.properties.date_fin.substr(5,2),feature.properties.date_fin.substr(8,2));
								if (d2<d1) return false; else return true;
							}
						}
						return false;
					},
					*/
					onEachFeature: onEachFeature,
					pointToLayer: function (feature, latlng) {
					//alert(feature.properties["id"]+" : "+Date.parse(feature.properties["date_debut"])/1000);
						return L.marker(latlng, {icon: dvdIcon, zIndexOffset: 1800, riseOnHover: true, riseOffset: 3000});
					}
				});
				
				var dt_from = "2014-07-15";
				var dt_to = "2016-08-12";
				
				$('.slider-time').html(dt_from);
				$('.slider-time2').html(dt_to);
				
				function zeroPad(num, places) {
				  var zero = places - num.toString().length + 1;
				  return Array(+(zero > 0 && zero)).join("0") + num;
				}
				function formatDT(__dt) {
				    var year = __dt.getFullYear();
				    var month = zeroPad(__dt.getMonth()+1, 2);
				    var date = zeroPad(__dt.getDate(), 2);
				    var hours = zeroPad(__dt.getHours(), 2);
				    var minutes = zeroPad(__dt.getMinutes(), 2);
				    var seconds = zeroPad(__dt.getSeconds(), 2);
				    return year + '-' + month + '-' + date;
				};
		
				var sliderControl = L.control.sliderControl({
				        layer: dvdpt_geojson,
				        range: false,
				        timeAttribute: "date_debut",
				        min: dt_from,
				        max: dt_to,
				        showAllOnStart: false,
				        slide: function (e, ui) {
			                var dt_cur_from = new Date(ui.values[0]*1000); //.format("yyyy-mm-dd");
			                $('.slider-time').html(ui.values[0]);
			                var dt_cur_to = new Date(ui.values[1]*1000); //.format("yyyy-mm-dd");                
			                $('.slider-time2').html(ui.values[1]);
			            }
				      });
				
				      //Make sure to add the slider to the map ;-)
				      maptrav.addControl(sliderControl);
				      //An initialize the slider
				      sliderControl.startSlider();
				dvdpt_geojson.addTo(TravauxDVD);
				}).fail(function(jqXHR, textStatus, errorThrown) {
			// Nothing to do, there simply will be no overlay
		});
		
		maptrav.fitBounds(fondCD.getBounds());
			
		//pour chaque trace de travaux DVD...
		function onEachFeature(feature, layer) {
			//on lui fait afficher une popup lors d'un click
			var popuptxt = '';
			if (feature.properties["type_operation"] !== null) popuptxt += '<b>Type de travaux :</b> ' + feature.properties["type_operation"]+'<br/>'; 
			if (feature.properties["nature_travaux"] !== null) popuptxt += '<b>Nature des travaux :</b> ' + feature.properties["nature_travaux"]+'<br/>';
			if (feature.properties["descriptif"] !== null) popuptxt += '<b>Description des travaux :</b> ' + feature.properties["descriptif"]+'<br/>';
			if (feature.properties["adresse"] !== null) popuptxt += '<b>Adresse :</b> ' + feature.properties["adresse"]+'<br/>';
			if (feature.properties["gene_occasionnee"] !== null) popuptxt += '<b>Gène occasionnée :</b> ' + feature.properties["gene_occasionnee"]+'<br/>';
			if (feature.properties["date_debut"] !== null) popuptxt += '<b>Date de début :</b> ' + feature.properties["date_debut"]+'<br/>';
		    if (feature.properties["date_fin"] !== null) popuptxt += '<b>Date de fin (prévision) :</b> ' +feature.properties["date_fin"];
		    layer.bindPopup(popuptxt);
		}
		//pour chaque trace de travaux DVD...
		function onEachFeatureCRE(feature, layer) {
			layer.bindPopup("load...").on('click', function(e) {
			    $.ajax({
			    	url: "#CHEMIN{fiche_travaux}",
			    	dataType: "html",
			    	
			    }).done(function(data) {
			        layer.getPopup.setContent(data);
			        layer.getPopup.update();
			    });
			 });
		}
		function onEachFeatureASE(feature, layer) {
			//on lui fait afficher une popup lors d'un click
			var popuptxt = '<h3>Circonscription ASE</h3>';
			if (feature.properties["geo_id"] !== null) popuptxt += '<b>geo_id :</b> ' + feature.properties["geo_id"]+'<br/>'; 
			if (feature.properties["nom_circons"] !== null) popuptxt += '<b>nom_circons :</b> ' + feature.properties["nom_circons"]+'<br/>';
			if (feature.properties["numero"] !== null) popuptxt += '<b>numero :</b> ' + feature.properties["numero"]+'<br/>';
			if (feature.properties["voie"] !== null) popuptxt += '<b>voie :</b> ' + feature.properties["voie"]+'<br/>';
			if (feature.properties["complement"] !== undefined) popuptxt += '<b>complement :</b> ' + feature.properties["complement"]+'<br/>';
			if (feature.properties["code_postal"] !== null) popuptxt += '<b>code_postal :</b> ' + feature.properties["code_postal"]+'<br/>';
			if (feature.properties["commune"] !== null) popuptxt += '<b>commune :</b> ' +feature.properties["commune"];
			layer.bindPopup(popuptxt);
		}
		function onEachFeaturePMI(feature, layer) {
			//on lui fait afficher une popup lors d'un click
			var popuptxt = '<h3>Centre de PMI</h3>';
			if (feature.properties["id_centre_pmi"] !== null) popuptxt += '<b>id_centre_pmi :</b> ' + feature.properties["id_centre_pmi"]+'<br/>';
			if (feature.properties["nom_centre_pmi"] !== null) popuptxt += '<b>nom_centre_pmi :</b> ' + feature.properties["nom_centre_pmi"]+'<br/>'; 
			if (feature.properties["adresse"] !== null) popuptxt += '<b>adresse :</b> ' + feature.properties["adresse"]+'<br/>';
			if (feature.properties["code_postal"] !== null) popuptxt += '<b>code_postal :</b> ' + feature.properties["code_postal"]+'<br/>';
			if (feature.properties["ville"] !== null) popuptxt += '<b>ville :</b> ' + feature.properties["ville"]+'<br/>';
			layer.bindPopup(popuptxt);
		}
</script>